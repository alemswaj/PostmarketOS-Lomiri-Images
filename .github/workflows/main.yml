name: Lomiri Images Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - device: trogdor
            vendor: google
            packages: "chatty,firefox-esr,gnome-software,flatpak,gnome-software-plugin-flatpak,gnome-contacts,gnome-weather,calls,phosh-antispam,dialect,gnome-maps,gnome-console,networkmanager,modemmanager,konsole"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install pmbootstrap
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git openssl
          git clone https://gitlab.com/postmarketOS/pmbootstrap.git
          mkdir -p ~/.local/bin
          ln -s "$PWD/pmbootstrap/pmbootstrap.py" ~/.local/bin/pmbootstrap
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          # Initialisation minimale pour vérifier l'installation
          ~/.local/bin/pmbootstrap --version

      - name: Configure and Build
        run: |
          # 1. Configuration initiale (non-interactive)
          pmbootstrap init \
            --work-path "$GITHUB_WORKSPACE/.pmbootstrap" \
            --mirror-alpine "http://dl-cdn.alpinelinux.org/alpine/" \
            --channel "edge" \
            --vendor "${{ matrix.vendor }}" \
            --device "${{ matrix.device }}" \
            --ui "lomiri" \
            --extra-packages "${{ matrix.packages }}"

          # 2. Passage sur la branche Lomiri pour pmaports
          cd "$GITHUB_WORKSPACE/.pmbootstrap/cache_git/pmaports"
          git checkout feature/lomiri || echo "Branche déjà sélectionnée ou inexistante"
          
          # 3. Installation / Génération du rootfs
          # On utilise --password pour définir le code PIN/MDP sans prompt
          pmbootstrap install --password 123456

      - name: Export and Compress Image
        run: |
          # Export de l'image vers le dossier de travail
          mkdir -p $GITHUB_WORKSPACE/output
          # On cherche l'image générée (le chemin peut varier selon la version de pmos)
          IMG_PATH=$(find "$GITHUB_WORKSPACE/.pmbootstrap/chroot_native/home/pmos/rootfs" -name "*.img" | head -n 1)
          
          if [ -z "$IMG_PATH" ]; then
            echo "Erreur: Image introuvable"
            exit 1
          fi

          sudo mv "$IMG_PATH" "$GITHUB_WORKSPACE/output/${{ matrix.vendor }}-${{ matrix.device }}.img"
          
          # Compression multithreadée
          cd $GITHUB_WORKSPACE/output
          xz -z9ev -T0 "${{ matrix.vendor }}-${{ matrix.device }}.img"

      - name: Upload Compressed Image
        uses: actions/upload-artifact@v4
        with:
          name: lomiri-image-${{ matrix.device }}
          path: output/${{ matrix.vendor }}-${{ matrix.device }}.img.xz
          retention-days: 5
